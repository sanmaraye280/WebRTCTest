<!DOCTYPE html>
<html>
<head>
    <title>WebRTC + SignalR Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
</head>
<body>

    <h2>WebRTC Test Page</h2>

    <p>Your Connection ID: <span id="conn"></span></p>
    <input id="target" placeholder="Target Connection ID" />

    <br /><br />

    <video id="localVideo" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
const hub = new signalR.HubConnectionBuilder()
    .withUrl("/callHub")
    .build();

let pc;

async function initWebRTC() {
    pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            hub.invoke("SendIceCandidate",
                document.getElementById("target").value,
                JSON.stringify(e.candidate));
        }
    };

    pc.ontrack = (e) => {
        document.getElementById("remoteVideo").srcObject = e.streams[0];
    };

    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    stream.getTracks().forEach(t => pc.addTrack(t, stream));
    document.getElementById("localVideo").srcObject = stream;
}

hub.on("YourConnectionId", id => {
    document.getElementById("conn").textContent = id;
});

hub.on("ReceiveOffer", async (from, offer) => {
    document.getElementById("target").value = from;

    await pc.setRemoteDescription(JSON.parse(offer));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    hub.invoke("SendAnswer", from, JSON.stringify(answer));
});

hub.on("ReceiveAnswer", async (from, answer) => {
    await pc.setRemoteDescription(JSON.parse(answer));
});

hub.on("ReceiveIceCandidate", async (from, candidate) => {
    await pc.addIceCandidate(JSON.parse(candidate));
});

(async function() {
    await hub.start();
    await initWebRTC();
})();

async function call() {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    hub.invoke("SendOffer",
        document.getElementById("target").value,
        JSON.stringify(offer));
}

    </script>

    <button onclick="call()">Start Call</button>

</body>
</html>
